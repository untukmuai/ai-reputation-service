name: Deploy Simulate to OVHCloud

on:
  push:
    branches:
      - simulate-ovhcloud

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_SERVER }}
          username: ${{ secrets.USERNAME_SERVER }}
          password: ${{ secrets.PASSWORD_SERVER }}

          script: |
            set -e

            echo "üìç Target directory: ${{ secrets.PATH_SERVER }}"

            if [ ! -d "${{ secrets.PATH_SERVER }}" ]; then
              echo "üìÅ Directory not found, creating..."
              mkdir -p ${{ secrets.PATH_SERVER }}
            fi

            cd ${{ secrets.PATH_SERVER }}

            if [ ! -d ".git" ]; then
              echo "üåÄ Cloning repository..."
              git clone ${{ secrets.GIT_REPO_URL }} .
            else
              echo "üîÑ Fetching latest changes..."
              git fetch --all
            fi

            echo "üöÄ Switching to simulate-ovhcloud branch"
            git checkout simulate-ovhcloud
            git pull origin simulate-ovhcloud
            git reset --hard origin/simulate-ovhcloud

            echo "üßπ Removing existing Dockerfile and compose"
            sudo rm -f docker-compose.yml

            echo "üìÑ Copying Dockerfile and docker-compose from server path"
            sudo cp ${{ secrets.PATH_DOCKER_COMPOSE }} docker-compose.yml

            echo "üîß Export env file path for Docker"
            export PATH_ENV_SERVER=${{ secrets.PATH_ENV_SERVER }}

            echo "üê≥ Rebuilding and restarting Docker containers"
            sudo docker compose down
            sudo docker compose up -d --build

            echo "‚è≥ Waiting for containers to initialize..."
            sleep 10

            echo "üì¶ Checking container status"
            sudo docker compose ps

            if sudo docker compose ps | grep -q "Up"; then
              echo "‚úÖ Deployment simulate-ovhcloud successful!"
              sudo docker compose logs --tail=50
            else
              echo "‚ùå Deployment failed!"
              sudo docker compose logs --tail=50
              exit 1
            fi

      - name: Deployment Success
        if: success()
        run: echo "‚úÖ simulate-ovhcloud deployment completed successfully."

      - name: Deployment Failed
        if: failure()
        run: echo "‚ùå simulate-ovhcloud deployment failed. Check server logs."